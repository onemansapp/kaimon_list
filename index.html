<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚³ãƒ³ãƒ‘ã‚¹æ–¹å‘ç·šãƒãƒƒãƒ—</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* å·¦ä¸‹ã®ä¸¸ã„ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ */
        #compassBtn {
            position: absolute;
            left: 10px;
            bottom: 80px;           /* ä½ç½®å–å¾—ãƒœã‚¿ãƒ³ã®ä¸Šã«è¢«ã‚‰ãªã„ã‚ˆã†ã« */
            width: 56px;
            height: 56px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            user-select: none;
        }
        #compassBtn:active {
            background: #f0f0f0;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ -->
<div id="compassBtn" title="æ–¹å‘ç·šã‚’è¡¨ç¤º/éè¡¨ç¤º">ğŸ§­</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// å¤‰æ•°
let map;
let userMarker;
let directionLine = null;        // æ–¹å‘ç·šï¼ˆPolylineï¼‰
let isLineVisible = false;
let currentHeading = 0;          // ç¾åœ¨ã®å‘ã„ã¦ã„ã‚‹æ–¹å‘ï¼ˆåº¦ï¼‰

// åœ°å›³åˆæœŸåŒ–
function initMap() {
    map = L.map('map').setView([35.681, 139.767], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ç¾åœ¨åœ°å–å¾—
    map.locate({ setView: true, maxZoom: 18, watch: true });
}

// ä½ç½®å–å¾—æˆåŠŸæ™‚
function onLocationFound(e) {
    const radius = e.accuracy / 2;

    if (!userMarker) {
        userMarker = L.circle(e.latlng, radius).addTo(map);
        L.marker(e.latlng).addTo(map)
            .bindPopup("ã‚ãªãŸã¯ã“ã“")
            .openPopup();
    } else {
        userMarker.setLatLng(e.latlng);
        userMarker.setRadius(radius);
        map.setView(e.latlng);
    }

    // ç¾åœ¨åœ°ãŒå–ã‚ŒãŸã‚‰ã‚³ãƒ³ãƒ‘ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–
    enableCompass();
}

// ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼
function onLocationError(e) {
    alert(e.message);
}

// ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆDeviceOrientationï¼‰ã®æœ‰åŠ¹åŒ–
function enableCompass() {
    if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', handleOrientation);
        
        // iOS 13+ ã¯è¨±å¯ãŒå¿…è¦
        if (DeviceOrientationEvent.requestPermission) {
            document.getElementById('compassBtn').addEventListener('click', requestCompassPermission);
        }
    } else {
        alert("ã“ã®ç«¯æœ«ã¯ã‚³ãƒ³ãƒ‘ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    }
}

function requestCompassPermission() {
    DeviceOrientationEvent.requestPermission()
        .then(response => {
            if (response === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        })
        .catch(console.error);
}

// æ–¹å‘ãŒå¤‰ã‚ã£ãŸã¨ã
function handleOrientation(event) {
    if (event.alpha !== null) {
        // iOS ã¨ Android ã§å‘ãã®è¨ˆç®—ãŒå°‘ã—é•ã†ãŒã€webkitCompassHeading ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
        if (event.webkitCompassHeading !== undefined) {
            currentHeading = event.webkitCompassHeading;  // iOS
        } else {
            currentHeading = 360 - event.alpha;           // Androidï¼ˆå¤§ä½“åˆã£ã¦ã‚‹ï¼‰
        }

        // ç·šãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ãªã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
        if (isLineVisible && userMarker) {
            drawDirectionLine();
        }
    }
}

// æ–¹å‘ç·šã‚’æãï¼ˆ1000må…ˆã¾ã§ï¼‰
function drawDirectionLine() {
    if (!userMarker) return;

    const center = userMarker.getLatLng();
    const distance = 1000000; // 1kmå…ˆã¾ã§ï¼ˆååˆ†é•·ã„ï¼‰

    // ç›®çš„åœ°ã®ç·¯åº¦çµŒåº¦ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šåœ°çƒã‚’å¹³é¢ã¨ä»®å®šï¼‰
    const bearing = currentHeading;
    const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆmï¼‰
    const rad = bearing * Math.PI / 180;

    const lat1 = center.lat * Math.PI / 180;
    const lon1 = center.lng * Math.PI / 180;

    const lat2 = Math.asin(
        Math.sin(lat1) * Math.cos(distance / R) +
        Math.cos(lat1) * Math.sin(distance / R) * Math.cos(rad)
    );
    const lon2 = lon1 + Math.atan2(
        Math.sin(rad) * Math.sin(distance / R) * Math.cos(lat1),
        Math.cos(distance / R) - Math.sin(lat1) * Math.sin(lat2)
    );

    const endLatLng = L.latLng(lat2 * 180 / Math.PI, lon2 * 180 / Math.PI);

    if (directionLine) {
        directionLine.setLatLngs([center, endLatLng]);
    } else {
        directionLine = L.polyline([center, endLatLng], {
            color: 'orange',
            weight: 6,
            opacity: 0.9
        }).addTo(map);
    }
}

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒˆã‚°ãƒ«
document.getElementById('compassBtn').addEventListener('click', function() {
    if (!userMarker) {
        alert("ç¾åœ¨åœ°ãŒã¾ã å–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
        return;
    }

    isLineVisible = !isLineVisible;

    if (isLineVisible) {
        drawDirectionLine();
        this.style.background = '#fff3e0';
    } else {
        if (directionLine) {
            map.removeLayer(directionLine);
            directionLine = null;
        }
        this.style.background = 'white';
    }
});

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);

// åœ°å›³åˆæœŸåŒ–
initMap();

</script>
</body>
</html>